version: '3.8'

# High-Availability FLURM cluster configuration
# 3 controllers with Ra consensus for fault tolerance testing

services:
  # Controller 1 (initial leader)
  flurm-ctrl-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-server-ha
    hostname: flurm-ctrl-1
    environment:
      - FLURM_NODE_NAME=flurm@flurm-ctrl-1
      - FLURM_COOKIE=flurm_cluster_secret
      - FLURM_CLUSTER_NODES=flurm@flurm-ctrl-1,flurm@flurm-ctrl-2,flurm@flurm-ctrl-3
      - FLURM_RA_DATA_DIR=/var/lib/flurm/ra
    ports:
      - "6817:6817"
    volumes:
      - munge-key:/etc/munge
      - ctrl1-data:/var/lib/flurm
    networks:
      flurm-ha-net:
        ipv4_address: 172.28.0.10

  # Controller 2
  flurm-ctrl-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-server-ha
    hostname: flurm-ctrl-2
    environment:
      - FLURM_NODE_NAME=flurm@flurm-ctrl-2
      - FLURM_COOKIE=flurm_cluster_secret
      - FLURM_CLUSTER_NODES=flurm@flurm-ctrl-1,flurm@flurm-ctrl-2,flurm@flurm-ctrl-3
      - FLURM_RA_DATA_DIR=/var/lib/flurm/ra
    ports:
      - "6827:6817"
    volumes:
      - munge-key:/etc/munge
      - ctrl2-data:/var/lib/flurm
    networks:
      flurm-ha-net:
        ipv4_address: 172.28.0.11
    depends_on:
      - flurm-ctrl-1

  # Controller 3
  flurm-ctrl-3:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-server-ha
    hostname: flurm-ctrl-3
    environment:
      - FLURM_NODE_NAME=flurm@flurm-ctrl-3
      - FLURM_COOKIE=flurm_cluster_secret
      - FLURM_CLUSTER_NODES=flurm@flurm-ctrl-1,flurm@flurm-ctrl-2,flurm@flurm-ctrl-3
      - FLURM_RA_DATA_DIR=/var/lib/flurm/ra
    ports:
      - "6837:6817"
    volumes:
      - munge-key:/etc/munge
      - ctrl3-data:/var/lib/flurm
    networks:
      flurm-ha-net:
        ipv4_address: 172.28.0.12
    depends_on:
      - flurm-ctrl-1

  # Compute nodes
  flurm-node-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-node
    hostname: flurm-node-1
    environment:
      - FLURM_CONTROLLER_HOST=flurm-ctrl-1
      - FLURM_CONTROLLER_PORT=6818
    networks:
      flurm-ha-net:
        ipv4_address: 172.28.0.20
    depends_on:
      - flurm-ctrl-1

  flurm-node-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-node
    hostname: flurm-node-2
    environment:
      - FLURM_CONTROLLER_HOST=flurm-ctrl-1
      - FLURM_CONTROLLER_PORT=6818
    networks:
      flurm-ha-net:
        ipv4_address: 172.28.0.21
    depends_on:
      - flurm-ctrl-1

  # SLURM client for testing
  slurm-client:
    build:
      context: .
      dockerfile: Dockerfile.slurm-client-munge
    hostname: slurm-client
    environment:
      - SLURM_CONF=/etc/slurm/slurm.conf
    volumes:
      - munge-key:/etc/munge
    networks:
      flurm-ha-net:
        ipv4_address: 172.28.0.100
    stdin_open: true
    tty: true
    depends_on:
      - flurm-ctrl-1

volumes:
  munge-key:
  ctrl1-data:
  ctrl2-data:
  ctrl3-data:

networks:
  flurm-ha-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
