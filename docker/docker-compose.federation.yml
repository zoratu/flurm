# Docker Compose for FLURM Federation Testing
#
# This creates two independent FLURM clusters that can be federated:
# - Cluster A: flurm-controller-a + flurm-node-a1
# - Cluster B: flurm-controller-b + flurm-node-b1
# - Shared client for testing cross-cluster operations
#
# Usage:
#   docker compose -f docker-compose.federation.yml up -d
#
# Federation setup:
#   # Add cluster B to cluster A's federation
#   curl -X POST http://localhost:6820/api/v1/federation/clusters \
#     -H "Content-Type: application/json" \
#     -d '{"name":"cluster-b","host":"flurm-controller-b","port":6817}'
#
#   # Add cluster A to cluster B's federation
#   curl -X POST http://localhost:6821/api/v1/federation/clusters \
#     -H "Content-Type: application/json" \
#     -d '{"name":"cluster-a","host":"flurm-controller-a","port":6817}'

services:
  # ============================================
  # Cluster A - Primary cluster
  # ============================================
  flurm-controller-a:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-server
    image: flurm-server:latest
    hostname: flurm-controller-a
    environment:
      - FLURM_CLUSTER_NAME=cluster-a
      - FLURM_CONTROLLER_HOST=flurm-controller-a
      - FLURM_FEDERATION_ENABLED=true
    ports:
      - "6817:6817"   # SLURM protocol
      - "6818:6818"   # Node daemon protocol
      - "6820:6820"   # REST API / metrics
    volumes:
      - munge-key-a:/etc/munge
      - flurm-data-a:/var/lib/flurm
    networks:
      federation-net:
        aliases:
          - flurm-controller-a
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6820/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  flurm-node-a1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-node
    hostname: flurm-node-a1
    depends_on:
      flurm-controller-a:
        condition: service_healthy
    environment:
      - FLURM_CONTROLLER_HOST=flurm-controller-a
      - FLURM_CONTROLLER_PORT=6818
      - FLURM_NODE_NAME=flurm-node-a1
      - FLURM_NODE_CPUS=4
      - FLURM_NODE_MEMORY=8192
    volumes:
      - munge-key-a:/etc/munge
    networks:
      federation-net:
        aliases:
          - flurm-node-a1

  flurm-node-a2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-node
    hostname: flurm-node-a2
    depends_on:
      flurm-controller-a:
        condition: service_healthy
    environment:
      - FLURM_CONTROLLER_HOST=flurm-controller-a
      - FLURM_CONTROLLER_PORT=6818
      - FLURM_NODE_NAME=flurm-node-a2
      - FLURM_NODE_CPUS=4
      - FLURM_NODE_MEMORY=8192
    volumes:
      - munge-key-a:/etc/munge
    networks:
      federation-net:
        aliases:
          - flurm-node-a2

  # ============================================
  # Cluster B - Secondary cluster
  # ============================================
  flurm-controller-b:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-server
    image: flurm-server:latest
    hostname: flurm-controller-b
    environment:
      - FLURM_CLUSTER_NAME=cluster-b
      - FLURM_CONTROLLER_HOST=flurm-controller-b
      - FLURM_FEDERATION_ENABLED=true
    ports:
      - "6827:6817"   # SLURM protocol (different host port)
      - "6828:6818"   # Node daemon protocol
      - "6821:6820"   # REST API / metrics
    volumes:
      - munge-key-b:/etc/munge
      - flurm-data-b:/var/lib/flurm
    networks:
      federation-net:
        aliases:
          - flurm-controller-b
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6820/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  flurm-node-b1:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-node
    hostname: flurm-node-b1
    depends_on:
      flurm-controller-b:
        condition: service_healthy
    environment:
      - FLURM_CONTROLLER_HOST=flurm-controller-b
      - FLURM_CONTROLLER_PORT=6818
      - FLURM_NODE_NAME=flurm-node-b1
      - FLURM_NODE_CPUS=8
      - FLURM_NODE_MEMORY=16384
    volumes:
      - munge-key-b:/etc/munge
    networks:
      federation-net:
        aliases:
          - flurm-node-b1

  flurm-node-b2:
    build:
      context: ..
      dockerfile: docker/Dockerfile.flurm-node
    hostname: flurm-node-b2
    depends_on:
      flurm-controller-b:
        condition: service_healthy
    environment:
      - FLURM_CONTROLLER_HOST=flurm-controller-b
      - FLURM_CONTROLLER_PORT=6818
      - FLURM_NODE_NAME=flurm-node-b2
      - FLURM_NODE_CPUS=8
      - FLURM_NODE_MEMORY=16384
    volumes:
      - munge-key-b:/etc/munge
    networks:
      federation-net:
        aliases:
          - flurm-node-b2

  # ============================================
  # Test Client
  # ============================================
  slurm-client:
    build:
      context: .
      dockerfile: Dockerfile.slurm-client-munge
    hostname: slurm-client
    depends_on:
      - flurm-controller-a
      - flurm-controller-b
    environment:
      - SLURM_CONF=/etc/slurm/slurm.conf
      - SLURMCTLD_HOST=flurm-controller-a
    volumes:
      - munge-key-a:/etc/munge
      - ./slurm-federation.conf:/etc/slurm/slurm.conf:ro
    networks:
      federation-net:
        aliases:
          - slurm-client
    stdin_open: true
    tty: true

volumes:
  munge-key-a:
  munge-key-b:
  flurm-data-a:
  flurm-data-b:

networks:
  federation-net:
    driver: bridge
