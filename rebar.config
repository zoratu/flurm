%% FLURM - Functional SLURM Implementation in Erlang
%% Umbrella Project Configuration

{erl_opts, [
    debug_info,
    warnings_as_errors,
    warn_unused_vars,
    warn_unused_import,
    warn_unused_function,
    {parse_transform, lager_transform}
]}.

%% Umbrella project - apps are in apps/ directory
%% {project_plugins, [rebar3_proper]}.

{deps, [
    %% Network acceptor pool
    {ranch, "2.1.0"},
    %% Raft consensus library for distributed state
    {ra, "2.7.3"},
    %% JSON encoding/decoding
    {jsx, "3.1.0"},
    %% Logging framework
    {lager, "3.9.2"},
    %% Prometheus metrics
    {prometheus, "4.11.0"},
    {prometheus_httpd, "2.1.11"}
]}.

%% Override compiler options for dependencies that don't compile with warnings_as_errors
{overrides, [
    {override, goldrush, [{erl_opts, [debug_info]}]},
    {override, lager, [{erl_opts, [debug_info]}]},
    {override, prometheus, [{erl_opts, [debug_info]}]},
    {override, quantile_estimator, [{erl_opts, [debug_info]}]}
]}.

{profiles, [
    {test, [
        {deps, [
            %% Mocking library
            {meck, "0.9.2"}
        ]},
        {erl_opts, [
            debug_info,
            nowarn_export_all,
            nowarn_unused_vars,
            {parse_transform, lager_transform}
        ]}
    ]},
    {prod, [
        {erl_opts, [
            no_debug_info,
            warnings_as_errors
        ]},
        {relx, [
            {dev_mode, false},
            {include_erts, true}
        ]}
    ]}
]}.

{relx, [
    {release, {flurm, "1.0.0"}, [
        flurm_config,
        flurm_protocol,
        flurm_core,
        flurm_db,
        flurm_controller,
        flurm_node_daemon,
        flurm_dbd,
        sasl,
        lager
    ]},
    {release, {flurmctld, "1.0.0"}, [
        flurm_config,
        flurm_protocol,
        flurm_core,
        flurm_db,
        flurm_controller,
        sasl,
        lager
    ]},
    {release, {flurmnd, "1.0.0"}, [
        flurm_config,
        flurm_protocol,
        flurm_core,
        flurm_node_daemon,
        sasl,
        lager
    ]},
    {release, {flurmbd, "1.0.0"}, [
        flurm_config,
        flurm_protocol,
        flurm_core,
        flurm_dbd,
        sasl,
        lager
    ]},
    {dev_mode, true},
    {include_erts, false},
    {extended_start_script, true},
    {sys_config, "config/sys.config"},
    {vm_args, "config/vm.args"},
    %% Hot upgrade configuration
    {generate_start_script, true},
    {extended_start_script_hooks, [
        {pre_start, [{custom, "hooks/pre_start"}]},
        {post_start, [{custom, "hooks/post_start"}]}
    ]},
    %% Include appup files for hot upgrades
    {overlay, [
        {mkdir, "releases/{{release_version}}/"},
        {copy, "scripts/flurm_upgrade.sh", "bin/flurm_upgrade"}
    ]}
]}.

{shell, [
    {apps, [flurm_controller, flurm_node_daemon]}
]}.

%% Dialyzer configuration
{dialyzer, [
    {warnings, [
        unmatched_returns,
        error_handling,
        underspecs
    ]},
    {plt_apps, top_level_deps},
    {plt_extra_apps, [ranch, ra]}
]}.

%% XRef cross-reference analysis
{xref_checks, [
    undefined_function_calls,
    undefined_functions,
    locals_not_used,
    deprecated_function_calls,
    deprecated_functions
]}.

%% Code coverage
{cover_enabled, true}.
{cover_opts, [verbose]}.
%% No excluded modules - we want 100% coverage
{cover_excl_mods, []}.

%% Proper configuration
{proper_opts, [
    {numtests, 100}
]}.
